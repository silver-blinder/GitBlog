# [æœåŠ¡ç«¯æ¸²æŸ“å®Œæ•´è¿‡ç¨‹æ¢³ç† + å…³äºæ°´åˆçš„ä¸€ä¸ªé—®é¢˜è§£å†³](https://github.com/silver-blinder/GitBlog/issues/3)

<h2>æœåŠ¡ç«¯æ¸²æŸ“ç›¸å…³ï¼š</h2>
<pre><code class="language-jsx">ç”¨æˆ·è®¿é—® ä¾‹å¦‚ï¼š /xvisa/product/detail?productid=12345
       â†“
æœåŠ¡å™¨æ¥æ”¶è¯·æ±‚
       â†“
NFES è·¯ç”±ç³»ç»Ÿåˆ¤æ–­ï¼šè¿™æ˜¯ SSR é¡µé¢ï¼ˆisForceCsr flagåˆ¤æ–­ï¼‰
       â†“
åŠ è½½é¡µé¢æ¨¡æ¿ (config/template/page.js)ï¼ˆå¦‚æœæœ‰ï¼Œç›¸å½“äºçˆ¶ç±»BasePageï¼‰
       â†“
æ¨¡æ¿åŠ¨æ€å¯¼å…¥é¡µé¢ (productDetail/index.tsx)
       â†“
è°ƒç”¨ BasePage.getInitialState(ctxï¼šä¸Šä¸‹æ–‡å¯¹è±¡ï¼ˆè¯¦è§psï¼‰)ï¼ˆæ¡†æ¶å†³å®šï¼Œå¼€å¯SSRåˆ™åœ¨æœåŠ¡ç«¯è¿è¡Œï¼‰
       â†“
åœ¨ getInitialState ä¸­æ£€æŸ¥å¹¶è°ƒç”¨å¯¹åº”å­ç±»çš„getTdk getStaticProps getInitialState
ï¼ˆå–å†³äºå¯¹åº”çš„å­ç±»æœ‰æ²¡æœ‰å®šä¹‰ï¼‰ 
(getTdk ï¼šSEOä¸­æ ‡é¢˜ï¼ˆTitleï¼‰ã€æè¿°ï¼ˆDescriptionï¼‰ã€å…³é”®è¯ï¼ˆKeywordsï¼‰ä¸‰ä¸ªå…ƒæ ‡ç­¾çš„ç»Ÿç§°ï¼›
 getStaticProps: æ„å»ºæ—¶æ‰§è¡Œ(build)ï¼›ä¸€æ¬¡æ€§ï¼›é™æ€æ•°æ®çš„è·å–
 getInitialStateï¼šè¯·æ±‚æ—¶æ‰§è¡Œï¼ˆç”¨æˆ·è®¿é—®æ—¶ï¼‰ï¼›å®æ—¶æ•°æ®ï¼›ä¸ªæ€§åŒ–å†…å®¹ ï¼‰
(ç±»ä¼¼äºnextjsä¸­çš„getStaticProps &amp;&amp; getServerSidePropsï¼‰
       â†“
è·å– SEO æ•°æ® { title, description, image } / initServerState / initState
       â†“
æ¸²æŸ“ HTML å¹¶æ³¨å…¥ SEO å…ƒæ ‡ç­¾ï¼ˆå¦‚æœæœ‰ï¼ŒNFESé‡ŒsetTDKä¼šè‡ªåŠ¨åœ¨metaæ ‡ç­¾å†…ï¼‰,å‘é€å®Œæ•´çš„ HTML
ç»™å®¢æˆ·ç«¯ï¼ˆå°†çŠ¶æ€åºåˆ—åŒ–åˆ° window.__INITIAL_STATE__ æˆ–ç±»ä¼¼çš„å…¨å±€å˜é‡ä¸­ï¼‰
(åŒé‡æ¸²æŸ“ï¼š
 ç¬¬ä¸€æ¬¡ï¼ˆæœåŠ¡ç«¯ï¼‰ï¼š
 const html = ReactDOMServer.renderToString(&lt;ProductDetail /&gt;);
 return `
      &lt;html&gt;
        &lt;head&gt;
	        &lt;title&gt;æ—¥æœ¬ä¸ªäººæ—…æ¸¸ç­¾è¯&lt;/title&gt;
				  &lt;meta name=&quot;description&quot; content=&quot;ä¸“ä¸šç­¾è¯æœåŠ¡ï¼Œå¿«é€ŸåŠç†æ—¥æœ¬ä¸ªäººæ—…æ¸¸ç­¾è¯&quot; /&gt;
					&lt;meta property=&quot;og:title&quot; content=&quot;æ—¥æœ¬ä¸ªäººæ—…æ¸¸ç­¾è¯&quot; /&gt;
				  &lt;meta property=&quot;og:description&quot; content=&quot;ä¸“ä¸šç­¾è¯æœåŠ¡...&quot; /&gt;
					&lt;meta property=&quot;og:image&quot; content=&quot;&lt;https://pic.ctrip.com/japan.jpg&gt;&quot; /&gt;
				  &lt;meta property=&quot;og:type&quot; content=&quot;website&quot; /&gt;
        &lt;/head&gt;
        &lt;body&gt;
          &lt;div id=&quot;root&quot;&gt;${html}&lt;/div&gt;
          &lt;script&gt;
            window.__INITIAL_STATE__ = {...initServerState, ...initState}
          &lt;/script&gt;
          &lt;script src=&quot;/app.js&quot;&gt;&lt;/script&gt;
        &lt;/body&gt;
      &lt;/html&gt;
    `;
)
æ°´åˆé˜¶æ®µç¬¬äºŒæ¬¡ï¼šReactDOM.hydrateRoot(document.getElementById('root'),
 &lt;ProductDetail /&gt;);
       â†“
å®¢æˆ·ç«¯æ°´åˆï¼š
(DOMæ¯”å¯¹å’Œå¤ç”¨ï¼›äº‹ä»¶ç›‘å¬å™¨ç»‘å®šï¼›çŠ¶æ€åˆå§‹åŒ–
 &lt;!-- æœåŠ¡ç«¯ç”Ÿæˆçš„HTML --&gt;
 &lt;div id=&quot;root&quot;&gt;
   &lt;h1&gt;æ¬¢è¿æ¥åˆ°ç½‘ç«™&lt;/h1&gt;
   &lt;button&gt;0&lt;/button&gt;  &lt;!-- é™æ€ï¼Œç‚¹å‡»æ— æ•ˆ --&gt;
 &lt;/div&gt;

 &lt;script&gt;
 // æ°´åˆè¿‡ç¨‹å¼€å§‹
 const App = () =&gt; {
   const [count, setCount] = useState(0);
   return (
     &lt;div&gt;
       &lt;h1&gt;æ¬¢è¿æ¥åˆ°ç½‘ç«™&lt;/h1&gt;
       &lt;button onClick={() =&gt; setCount(count + 1)}&gt;{count}&lt;/button&gt;
     &lt;/div&gt;
   );
 };

 // Reactçš„æ°´åˆ
 ReactDOM.hydrateRoot(document.getElementById('root'), &lt;App /&gt;);

 // å†…éƒ¨è¿‡ç¨‹ï¼š
 // 1. æ£€æŸ¥h1æ ‡ç­¾ï¼šå†…å®¹åŒ¹é… âœ… -&gt; å¤ç”¨
 // 2. æ£€æŸ¥buttonæ ‡ç­¾ï¼šå†…å®¹åŒ¹é… âœ… -&gt; å¤ç”¨ + ç»‘å®šonClick
 // 3. åˆå§‹åŒ–useState(0)
 // 4. ç°åœ¨buttonå¯ä»¥å“åº”ç‚¹å‡»äº†ï¼ğŸ‰
 &lt;/script&gt;)
</code></pre>
<p>psï¼š</p>
<p>ctxÂ æ˜¯<strong>NfesÂ æ¡†æ¶ï¼ˆNextjsä¹Ÿæ˜¯ç±»ä¼¼ï¼‰åœ¨æœåŠ¡ç«¯æ¸²æŸ“æ—¶è‡ªåŠ¨åˆ›å»ºå¹¶ä¼ é€’çš„ä¸Šä¸‹æ–‡å¯¹è±¡</strong></p>
<p>ï¼Œå®ƒåŒ…å«äº†ï¼š</p>
<ul>
<li><strong>HTTPÂ è¯·æ±‚/å“åº”å¯¹è±¡</strong>Â (req/res)</li>
<li><strong>URL å‚æ•°</strong>Â (query)</li>
<li><strong>è·¯ç”±ä¿¡æ¯</strong>Â (pathname,Â params)</li>
<li><strong>å…¶ä»–è¯·æ±‚ç›¸å…³ä¿¡æ¯</strong></li>
</ul>
<h2>è®°å½•ä¸€ä¸ªæ°´åˆç›¸å…³çš„æŠ¥é”™ï¼š</h2>
<p>èµ·å› ï¼šå‡ºç°ä»¥ä¸‹æŠ¥é”™</p>
<pre><code>Warning: Did not expect server HTML to contain a &lt;div&gt; in &lt;div&gt;. Error Component 
Stack

hook.js:608 Warning: An error occurred during hydration. The server HTML was 
replaced with client content in &lt;div&gt;. 

hydration-dev.js:31 Uncaught Error: [NFES] Page Error due to Hydration Failed, 
Please fix hydration errors above.
</code></pre>
<p>é€šè¿‡å‚è€ƒæ–‡æ¡£ï¼š<a href="https://nextjs.org/docs/messages/react-hydration-error%EF%BC%8C%E4%BB%A5%E5%8F%8A%E4%B8%8A%E8%BF%B0%E5%85%B3%E4%BA%8E%E4%BA%8C%E6%AC%A1%E6%B8%B2%E6%9F%93%E7%9A%84%E5%88%86%E6%9E%90%E5%8F%AF%E7%9F%A5%EF%BC%9A">https://nextjs.org/docs/messages/react-hydration-errorï¼Œä»¥åŠä¸Šè¿°å…³äºäºŒæ¬¡æ¸²æŸ“çš„åˆ†æå¯çŸ¥ï¼š</a></p>
<p>æœ¬è´¨æ˜¯ <strong>æœåŠ¡ç«¯æ¸²æŸ“ä¸å®¢æˆ·ç«¯æ¸²æŸ“çš„å†…å®¹ä¸ä¸€è‡´ã€‚</strong></p>
<p>å…·ä½“åœºæ™¯ï¼š</p>
<pre><code>// ç¯å¢ƒåˆ¤æ–­
const isTds = () =&gt; {
  const isH5 = xEnv.getPlatform() === xEnv.PLATFORM_TYPE.H5
  // å…ˆåªåˆ¤æ–­h5
  if (!isH5) return false
  if (xUa.isInServer()) return false
  let host = window?.location?.host
  if (host) {
    return host.includes('bst')
  } else {
    return false
  }
}

const isInWechatMiniProgram = () =&gt; {
  if (xUa.isInServer()) return false
  if (xEnv.getPlatform() === xEnv.PLATFORM_TYPE.CRN) return false
  try {
    let userAgent = getUserAgent().toLowerCase()
    if (userAgent.indexOf('micromessenger') &gt; -1) {
      return (
        window.__wxjs_environment === 'miniprogram' ||
        /miniProgram/i.test(window.navigator.userAgent)
      )
    } else {
      return false
    }
  } catch (e) {
    return false
  }
}

const isInTdsMiniProgram = () =&gt; {
  if (xUa.isInServer()) return false
  return isInWechatMiniProgram() &amp;&amp; isTds()
}
</code></pre>
<pre><code>const ProductDetail = (props) =&gt; {
  console.log('isInTdsMini',isInTdsMiniProgram())
  return (
    &lt;XView &gt;
      &lt;Header /&gt;
      ....
    &lt;/Xview&gt;
  )
}
</code></pre>
<p>æŠ¥é”™å‘ç”Ÿåœ¨ProductDetailé¡µé¢ä¸Šï¼Œæ ¹æ®æ–‡æ¡£ï¼Œé¦–å…ˆæœ€æœ‰å¯èƒ½çš„æ˜¯åœ¨ç»„ä»¶å†…ä½¿ç”¨/è°ƒç”¨äº†å’Œwindowç›¸å…³/å®¢æˆ·ç«¯ä¸‹çš„APIï¼Œä½†æ£€æŸ¥äº†ä¸€ä¸‹å‘ç°å¹¶æ²¡æœ‰ï¼›</p>
<p>ç„¶åä¸€ç›´è§‰å¾—ååˆ†å¥‡æ€ªï¼šå¯¹äºisInTdsMiniProgram çš„åˆ¤æ–­ åœ¨æœåŠ¡ç«¯å†…ä¼šè¢«ç›´æ¥è¿”å›falseï¼›åœ¨å®¢æˆ·ç«¯å†…isTdsç”±äºåŸŸåä¸æ˜¯bstç›¸å…³ä¹Ÿä¼šè¿”å›falseï¼Œä¹Ÿå°±æ˜¯è¯´isInTdsMiniProgramåœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¸‹éƒ½ä¼šæ˜¯falseï¼Œæ€ä¹ˆä¼šå‡ºç°æ°´åˆä¸ä¸€è‡´çš„æƒ…å†µå‘¢ï¼Ÿ</p>
<p>ç„¶åå°±è¿›å…¥è°ƒè¯•é˜¶æ®µï¼Œåœ¨ä¸¤ç«¯å†…åˆ†åˆ«è¾“å‡ºäº†ä¸€ç³»åˆ—å€¼ï¼ˆä¾‹å¦‚isInTdsMiniProgramã€isTdsã€isH5ç­‰ç­‰ç­‰ï¼‰ï¼Œç»è¿‡å°è¯•ï¼Œæˆ‘å‘ç°é—®é¢˜å¯èƒ½å‡ºåœ¨isTdsè¿™é‡Œï¼Œå½“æˆ‘å¼ºåˆ¶å°†è¿™ä¸ªå€¼è¿”å›trueçš„æ—¶å€™ï¼Œæ°´åˆä¸ä¸€è‡´æŠ¥é”™æ¶ˆå¤±ï¼Œè¿”å›falseæ—¶ï¼Œå°±ä¼šæŠ¥é”™ã€‚</p>
<p>é¡ºç€è¿™ä¸ªæ€è·¯ï¼Œæˆ‘å‘ç°isInTdsMiniProgramä¸ä¸€è‡´åè€Œä¸ä¼šæŠ¥æ°´åˆçš„é”™è¯¯ï¼Œé‚£å°±è¯´æ˜ä¸€å®šæœ‰åˆ«çš„åˆ¤æ–­ä¹Ÿæ˜¯åœ¨æœåŠ¡ç«¯/å®¢æˆ·ç«¯ä¸ä¸€è‡´ï¼Œè´Ÿè´Ÿå¾—æ­£çš„æ„Ÿè§‰ã€‚</p>
<p>æœ€ååœ¨Headerå†…æ‰¾åˆ°äº†é—®é¢˜ï¼š</p>
<pre><code>const Header = (props: Props) =&gt; {
  if ((xUa.isMini() || xUa.isInMini()) &amp;&amp; !isInTdsMiniProgram()) return null
  ....
}
</code></pre>
<p><strong>æƒ…å†µ1ï¼šisTds()Â è¿”å›Â false</strong></p>

ç¯å¢ƒ | xUa.isInMini() | isInTdsMiniProgram() | Headeræ¡ä»¶ | æ¸²æŸ“ç»“æœ
-- | -- | -- | -- | --
æœåŠ¡ç«¯ | false | false | false && trueÂ â†’Â false | æ­£å¸¸æ¸²æŸ“
å®¢æˆ·ç«¯ | true | false | true && trueÂ â†’Â true | è¿”å› null


<p><strong>ç»“æœ</strong>ï¼šæ°´åˆä¸€è‡´</p>
<p>åŸå› åœ¨äºxUa.isInMini()è¿™ä¸ªæ–¹æ³•åœ¨æœåŠ¡ç«¯å†…ä¼šè¿”å›falseï¼Œå®¢æˆ·ç«¯å†…æ‰ä¼šè¿”å›trueï¼ˆ navigatoræ–¹æ³•åˆ¤æ–­uaï¼‰ã€‚</p>
<p>å½“ç„¶è¿™åªæ˜¯è°ƒè¯•é˜¶æ®µå‡ºç°çš„é—®é¢˜ï¼Œç”Ÿäº§æµ‹è¯•ä¸Šä¼šæ›´æ”¹hostï¼ˆäºŒç¼–ï¼šæœ€ç»ˆæ”¹æˆäº†æ ¹æ®ç™»é™†æ€åˆ¤æ–­cookieï¼‰ï¼Œä½†é€šè¿‡è¿™ä¸ªä¾‹å­æ›´åŠ æ·±å…¥ç†è§£äº†æ°´åˆè¿™ä¸€è¿‡ç¨‹ï¼Œä¹Ÿæé†’æˆ‘ä¸è¦è½»æ˜“æƒ³å½“ç„¶ï¼ˆæƒ³å½“ç„¶çš„è®¤ä¸ºisInTdsMiniProgramå€¼å°±æ˜¯åº”è¯¥ä¸€è‡´ï¼‰ã€‚</p>